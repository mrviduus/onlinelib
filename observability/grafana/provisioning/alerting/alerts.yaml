apiVersion: 1

groups:
  - orgId: 1
    name: OnlineLib Ingestion Alerts
    folder: OnlineLib
    interval: 1m
    rules:
      - uid: ingestion-high-failure-rate
        title: High Ingestion Failure Rate
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum(rate(onlinelib_ingestion_jobs_succeeded_total[15m]))
              intervalMs: 1000
              maxDataPoints: 43200
              refId: A
          - refId: B
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum(rate(onlinelib_ingestion_jobs_failed_total[15m]))
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
          - refId: C
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0.05
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    type: last
              expression: $B / ($A + $B)
              type: math
              refId: C
        noDataState: OK
        execErrState: Error
        for: 15m
        annotations:
          summary: "Ingestion failure rate > 5%"
          description: "The ingestion pipeline has a failure rate exceeding 5% over the last 15 minutes."
        labels:
          severity: warning

      - uid: ingestion-critical-failure-rate
        title: Critical Ingestion Failure Rate
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum(rate(onlinelib_ingestion_jobs_succeeded_total[15m]))
              refId: A
          - refId: B
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum(rate(onlinelib_ingestion_jobs_failed_total[15m]))
              refId: B
          - refId: C
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: __expr__
            model:
              expression: $B / ($A + $B)
              type: math
              refId: C
              conditions:
                - evaluator:
                    params:
                      - 0.10
                    type: gt
        noDataState: OK
        execErrState: Error
        for: 15m
        annotations:
          summary: "Critical: Ingestion failure rate > 10%"
          description: "The ingestion pipeline has a critical failure rate exceeding 10%."
        labels:
          severity: critical

      - uid: extraction-latency-high
        title: High Extraction Latency
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: prometheus
            model:
              expr: histogram_quantile(0.95, sum(rate(onlinelib_extraction_duration_ms_bucket[15m])) by (le)) > 60000
              refId: A
        noDataState: OK
        execErrState: Error
        for: 15m
        annotations:
          summary: "Extraction p95 latency > 60s"
          description: "The 95th percentile extraction duration exceeds 60 seconds."
        labels:
          severity: warning

      - uid: backlog-growing
        title: Ingestion Backlog Growing
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 1800
              to: 0
            datasourceUid: prometheus
            model:
              expr: onlinelib_ingestion_jobs_pending > 100
              refId: A
        noDataState: OK
        execErrState: Error
        for: 30m
        annotations:
          summary: "Ingestion backlog > 100 jobs"
          description: "There are more than 100 jobs pending in the queue for over 30 minutes."
        labels:
          severity: warning

      - uid: queue-stale
        title: Ingestion Queue Stale
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 1800
              to: 0
            datasourceUid: prometheus
            model:
              expr: onlinelib_ingestion_queue_lag_ms > 3600000
              refId: A
        noDataState: OK
        execErrState: Error
        for: 30m
        annotations:
          summary: "Queue lag > 1 hour"
          description: "The oldest pending job has been waiting for more than 1 hour."
        labels:
          severity: critical

      - uid: ocr-spike
        title: OCR Usage Spike
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum(rate(onlinelib_extraction_ocr_used_total[15m]))
              refId: A
          - refId: B
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum(rate(onlinelib_ingestion_jobs_started_total[15m]))
              refId: B
          - refId: C
            relativeTimeRange:
              from: 900
              to: 0
            datasourceUid: __expr__
            model:
              expression: $A / $B
              type: math
              refId: C
              conditions:
                - evaluator:
                    params:
                      - 0.50
                    type: gt
        noDataState: OK
        execErrState: Error
        for: 15m
        annotations:
          summary: "OCR usage > 50% of jobs"
          description: "More than 50% of ingested files are requiring OCR, which may indicate many scanned documents."
        labels:
          severity: info
